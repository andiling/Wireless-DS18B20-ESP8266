<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>J6B Wireless DS18B20</title>
    </head>
    <body style="background-color: #ffdb99; Color: #000000;font-family: Arial;">
        <h1>J6B Wireless DS18B20</h1>
        <h2 style="display:inline">Firmware Management Page</h2><span id="l1"><h2 style="display:inline"><b> Loading...</b></h2></span>

        <h3>Upload a new Firmware : </h3>
        <form id="f1" method='POST' action='/fw' enctype='multipart/form-data' onsubmit='return confirm("Are you sure to flash firmware?");'>
            <input type='file' name='fi1' id='f1' accept='.bin'>
            <input type='submit' value='/!\ Upload Firmware /!\' >
            <span id='r1'></span>
        </form>

        <h3>Upload a Web File : </h3>
        <form id='f2' method='POST' action='/up' enctype='multipart/form-data'>
            <input type='file' name='fi2' id='fi2'>
            <input type='submit' value='Upload File'>
            <span id='r2'></span>
        </form>
        
        <br><br>
        <span id='dynSpan' style='display: none;'>
            SPIFFS used/total size : <span id='u'></span> / <span id='t'></span><br>
            <h3>File list :<span id='l2'> Loading...</span></h3>
            <h4>Files : <span id="nb">3</span></h4>
            <table id='fl'></table>
        </span>

        <script src="/jquery-3.1.1.min.js" type="text/javascript"></script>
        <script>
            if (!window.jQuery){
                document.write('<script type="text/javascript" src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.1.1.min.js"><\/script>');
                document.getElementById('l1').innerHTML='<h4 style="display:inline"> (JQuery loaded from Internet)</h4>';
            }
            else $("#l1").fadeOut();
        </script>
        <script>
            if (!window.jQuery) {
                document.getElementById('l1').innerHTML='<h4 style="display:inline"> (BASIC MODE)</h4>';
                alert('JQuery load failed. UI is in basic mode.');
            }
        </script>
        <script>

            function refreshFL(){
                
                $("#l2").fadeIn();
                $("#fl").html('<tr><th><b>filename</b></th><th><b>size</b></th><th></th></tr>');
                $.getJSON("/fl", function(FileList){

                    $.each(FileList,function(k,v){
                        if(k!='fl') $('#'+k).html(v);
                    });
                    
                    $.each(FileList.fl,function(i,v){
                        $("#fl").append("<tr><th>"+v.n+"</th><th>"+v.s+"</th><th><input type='button' id='db"+i+"' value='Delete'></th></tr><br>");
                        $("#db"+i).click(function(evt){
                            $.get('/rm?n='+escape(v.n)).always(refreshFL);
                        });
                    });
                    $("#l2").fadeOut();
                });
            };

            function UploadProgress(r){
                    var xhr = $.ajaxSettings.xhr() ;
                    xhr.upload.onprogress = function(evt){ r.html('In Progress'); if(evt.lengthComputable) {r.append(' : '+evt.loaded/evt.total*100+'%');}; } ;
                    return xhr;
            };

        $("#f1").submit(function(evt){
            evt.preventDefault();
            $.ajax({
                url:'/fw',type:'POST',cache: false,contentType: false,processData: false,
                data:new FormData($('#f1')[0]),
                xhr: function(){return UploadProgress($('#r1'));},
                success:function(d,s){
                    var reload15sec=document.createElement('script');
                    reload15sec.text='var count=14;var cdi=setInterval(function(){$("#cd").text(count);if(!count){clearInterval(cdi);location.reload();}count--;},1000);';
                    $('#r1').html('<span style="color: green;"><b>Done</b></span> System is rebooting. This page will be reloaded in <span id="cd">15</span>sec.').append(reload15sec);
                    $('#f1').trigger('reset');
                },
                error:function(){
                    $('#r1').html('<span style="color: red;"><b>Failed</b></span>');
                    $('#f1').trigger('reset');
                }
            });
        });

        $("#f2").submit(function(evt){
            evt.preventDefault();
            $('#r2').empty().show();

            $.ajax({
                url:'/up',type:'POST',cache: false,contentType: false,processData: false,
                data:new FormData($('#f2')[0]),
                xhr: function(){return UploadProgress($('#r2'));},
                success:function(d,s){
                    $('#r2').html('<span style="color: green;"><b>Done</b></span>').fadeOut(5000);
                    $('#f2').trigger('reset');
                    refreshFL();
                },
                error:function(){
                    $('#r2').html('<span style="color: red;"><b>Failed</b></span>').fadeOut(5000);
                    $('#f2').trigger('reset');
                }
            });
        });

        $(document).ready(function(){
            $("#dynSpan").fadeIn();
            refreshFL();
        });

        </script>
    </body>
</html>